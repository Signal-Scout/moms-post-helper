<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mom's Post Helper</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400;1,9..144,600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --terra: #b3612d; --terra-light: #f8ede0; --terra-dark: #7a3d14;
    --cream: #fefaf3; --cream-dark: #f4ead8; --border: #e8d8c0;
    --ink: #1c1008; --ink-mid: #5a3820; --ink-light: #9c7d60;
    --sage: #4e8f6a; --sage-light: #e2f0e8; --sage-dark: #2e6247;
    --gold: #c08010; --gold-light: #fdf3d4;
    --red: #c43030; --red-light: #fdecea;
    --shadow: rgba(28,16,8,0.07); --shadow-md: rgba(28,16,8,0.12); --shadow-lg: rgba(28,16,8,0.2);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body::before {
    content:''; position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.04;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    background-size:180px;
  }
  body {
    font-family:'DM Sans',sans-serif; background:var(--cream-dark);
    min-height:100vh; color:var(--ink);
    background-image:
      radial-gradient(ellipse 90% 55% at 20% -5%, rgba(179,97,45,0.14) 0%, transparent 60%),
      radial-gradient(ellipse 70% 50% at 90% 105%, rgba(78,143,106,0.11) 0%, transparent 55%);
  }
  .wrap { position:relative; z-index:1; max-width:680px; margin:0 auto; padding:44px 20px 100px; }

  /* Header */
  .header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:36px; }
  .header-eyebrow { font-size:10.5px; font-weight:700; letter-spacing:.16em; text-transform:uppercase; color:var(--terra); margin-bottom:10px; opacity:.85; }
  .header-title { font-family:'Fraunces',serif; font-size:44px; font-weight:700; color:var(--ink); line-height:.95; letter-spacing:-2.5px; }
  .header-title em { font-style:italic; color:var(--terra); }
  .header-right { display:flex; align-items:center; gap:10px; margin-top:8px; }

  /* Header icon buttons */
  .icon-btn {
    width:42px; height:42px; border-radius:13px;
    background:var(--cream); border:1.5px solid var(--border);
    box-shadow:0 2px 8px var(--shadow), inset 0 1px 0 rgba(255,255,255,.9);
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    font-size:17px; flex-shrink:0; position:relative;
    transition:background .2s, border-color .2s, box-shadow .2s;
  }
  .icon-btn:hover { background:white; border-color:var(--ink-light); box-shadow:0 4px 14px var(--shadow-md); }
  .settings-btn:hover .gear-icon { transform:rotate(45deg); }
  .gear-icon { display:inline-block; transition:transform .35s cubic-bezier(.34,1.56,.64,1); }
  .settings-dot { position:absolute; top:7px; right:7px; width:7px; height:7px; border-radius:50%; background:var(--terra); border:2px solid var(--cream-dark); display:none; }
  .settings-dot.show { display:block; }

  /* Info popover */
  .info-popover-wrap { position:relative; }
  .info-popover {
    display:none; position:absolute; top:calc(100% + 10px); right:0; z-index:100;
    background:white; border:1.5px solid var(--border); border-radius:16px;
    box-shadow:0 12px 40px var(--shadow-lg); padding:18px 20px; width:290px;
    animation:sheetIn .2s cubic-bezier(.22,1,.36,1);
  }
  .info-popover.open { display:block; }
  .info-popover-title { font-size:10px; font-weight:700; letter-spacing:.14em; text-transform:uppercase; color:var(--gold); margin-bottom:10px; }
  .info-popover p { font-size:13px; color:var(--ink-mid); line-height:1.65; }

  /* No-combos warning */
  .no-combos-warn {
    background:var(--terra-light); border:1px solid rgba(179,97,45,.25);
    border-radius:13px; padding:14px 16px;
    font-size:13px; color:var(--terra-dark); line-height:1.55;
    margin-bottom:16px; display:none; gap:10px; align-items:center;
    box-shadow:0 2px 10px rgba(179,97,45,.08);
  }
  .no-combos-warn.show { display:flex; }
  .no-combos-warn button {
    background:var(--terra); color:white; border:none; border-radius:8px;
    padding:7px 14px; font-size:12px; font-weight:600; font-family:'DM Sans',sans-serif;
    cursor:pointer; white-space:nowrap; flex-shrink:0; transition:background .15s;
  }
  .no-combos-warn button:hover { background:var(--terra-dark); }

  /* Cards */
  .card {
    background:white; border-radius:20px; border:1px solid var(--border);
    box-shadow:0 2px 16px var(--shadow), 0 1px 0 rgba(255,255,255,.9) inset;
    margin-bottom:14px; overflow:hidden; position:relative;
  }
  .card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:1px;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.9) 30%, rgba(255,255,255,.9) 70%, transparent);
    pointer-events:none;
  }
  .card-top {
    display:flex; align-items:center; justify-content:space-between;
    padding:13px 20px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, var(--cream) 0%, rgba(254,250,243,.7) 100%);
  }
  .card-label { font-size:10.5px; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--ink-light); display:flex; align-items:center; gap:6px; }
  .card-dot { width:5px; height:5px; border-radius:50%; background:var(--terra); }
  .card-body { padding:18px 20px; }

  /* URL Input row */
  .url-row { display:flex; gap:10px; }
  .url-row input {
    flex:1; border:1.5px solid var(--border); border-radius:11px;
    padding:12px 14px; font-family:'DM Sans',sans-serif; font-size:15px;
    color:var(--ink); background:var(--cream); outline:none;
    transition:border-color .2s, box-shadow .2s, background .2s;
  }
  .url-row input:focus { border-color:var(--terra); box-shadow:0 0 0 3.5px rgba(179,97,45,.12); background:white; }
  .url-row input::placeholder { color:#c0a88a; }
  .add-btn {
    padding:12px 20px; background:var(--ink); color:white; border:none; border-radius:11px;
    font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600; cursor:pointer;
    white-space:nowrap; transition:background .15s, transform .1s;
    box-shadow:0 2px 10px var(--shadow-md);
  }
  .add-btn:hover { background:#2e1a08; }
  .add-btn:active { transform:scale(.98); }
  .add-btn:disabled { background:var(--border); color:var(--ink-light); cursor:not-allowed; box-shadow:none; }

  /* Queue list */
  .queue-empty {
    text-align:center; padding:40px 20px; color:var(--ink-light); font-size:14px; line-height:1.6;
  }
  .queue-empty-icon { font-size:36px; margin-bottom:12px; opacity:.5; }

  .queue-item {
    display:flex; align-items:flex-start; gap:14px;
    padding:14px 0; border-bottom:1px solid var(--border);
    animation:fadeUp .25s cubic-bezier(.22,1,.36,1) both;
    transition:opacity .15s;
  }
  .queue-item.no-anim { animation:none; }
  .queue-item:last-child { border-bottom:none; }
  .queue-item.drag-over { border-top:2px solid var(--terra); margin-top:-1px; }
  .queue-item.dragging { opacity:.35; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  .qi-drag {
    color:var(--border); font-size:16px; cursor:grab; flex-shrink:0;
    margin-top:5px; user-select:none; transition:color .15s; line-height:1;
  }
  .qi-drag:hover { color:var(--ink-light); }
  .qi-drag:active { cursor:grabbing; }

  .qi-num {
    width:28px; height:28px; border-radius:50%; background:var(--cream-dark);
    border:1.5px solid var(--border); flex-shrink:0;
    font-size:12px; font-weight:700; color:var(--ink-light);
    display:flex; align-items:center; justify-content:center; margin-top:2px;
  }
  .qi-content { flex:1; min-width:0; }
  .qi-url { font-size:13px; font-weight:500; color:var(--ink); word-break:break-word; overflow-wrap:anywhere; margin-bottom:8px; line-height:1.4; }
  .qi-url a { color:var(--terra-dark); text-decoration:none; }
  .qi-url a:hover { text-decoration:underline; }
  .qi-statuses { display:flex; flex-wrap:wrap; gap:5px; }

  .queue-item.all-posted { opacity:.65; }
  .queue-item.all-posted .qi-num { background:var(--sage-light); border-color:var(--sage); color:var(--sage-dark); }

  /* Batch dividers */
  .batch-divider {
    display:flex; align-items:center; gap:10px;
    padding:10px 0 6px; margin-top:4px;
  }
  .batch-divider:first-child { margin-top:0; padding-top:6px; }
  .batch-divider::before, .batch-divider::after {
    content:''; flex:1; height:1px; background:var(--border);
  }
  .batch-divider-label {
    font-size:10px; font-weight:700; letter-spacing:.12em; text-transform:uppercase;
    color:var(--ink-light); white-space:nowrap; padding:0 4px;
  }
  .batch-divider.current .batch-divider-label {
    color:var(--terra); background:var(--terra-light); border-radius:99px;
    padding:2px 8px; border:1px solid rgba(179,97,45,.2);
  }
  .batch-divider.current::before, .batch-divider.current::after { background:rgba(179,97,45,.2); }
  .batch-divider.done .batch-divider-label { color:var(--sage-dark); }

  .status-chip {
    display:flex; align-items:center; gap:5px;
    border-radius:20px; padding:3px 10px; font-size:11px; font-weight:600;
    border:1px solid transparent; cursor:pointer; user-select:none;
    transition:opacity .15s, filter .15s;
  }
  .status-chip:hover { filter:brightness(.95); }
  .status-chip.pending { background:var(--cream-dark); border-color:var(--border); color:var(--ink-light); }
  .status-chip.working { background:var(--gold-light); border-color:rgba(192,128,16,.3); color:var(--gold); animation:pulse-chip .8s ease-in-out infinite alternate; }
  .status-chip.posted  { background:var(--sage-light); border-color:rgba(78,143,106,.3); color:var(--sage-dark); cursor:default; }
  .status-chip.failed  { background:var(--red-light); border-color:rgba(196,48,48,.2); color:var(--red); }
  .status-chip.skipped { background:var(--cream-dark); border-color:var(--border); color:var(--border); text-decoration:line-through; opacity:.6; }
  .status-chip.skipped .chip-dot { background:var(--border); }
  @keyframes pulse-chip { from{opacity:.7} to{opacity:1} }

  .chip-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
  .pending  .chip-dot { background:var(--ink-light); }
  .working  .chip-dot { background:var(--gold); }
  .posted   .chip-dot { background:var(--sage); }
  .failed   .chip-dot { background:var(--red); }

  .qi-remove {
    background:none; border:none; cursor:pointer; color:var(--ink-light);
    font-size:13px; padding:4px; flex-shrink:0; border-radius:6px;
    transition:color .15s, background .15s; margin-top:2px;
  }
  .qi-remove:hover { color:var(--red); background:var(--red-light); }
  .qi-retry {
    background:none; border:none; cursor:pointer;
    font-size:14px; padding:4px 6px; flex-shrink:0; border-radius:6px;
    color:var(--ink-light); transition:color .15s, background .15s;
    line-height:1;
  }
  .qi-retry:hover { color:var(--terra); background:var(--terra-light); }

  /* Progress bar ‚Äî lives inside queue card footer */
  .progress-footer { padding:14px 20px 16px; border-top:1px solid var(--border); }
  .progress-bar-track { height:4px; background:var(--border); border-radius:99px; overflow:hidden; }
  .progress-bar-fill { height:100%; background:var(--sage); border-radius:99px; transition:width .4s ease; }
  .progress-bar-label { font-size:11px; color:var(--ink-light); margin-top:6px; font-weight:500; }

  /* Bottom action row */
  .action-row { display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
  .btn-ghost {
    display:none; padding:10px 14px; background:none; color:var(--ink-light);
    border:none; border-radius:11px; font-family:'DM Sans',sans-serif;
    font-size:13px; font-weight:500; cursor:pointer; transition:color .15s, background .15s;
  }
  .btn-ghost:hover { color:var(--ink); background:var(--cream-dark); }
  .btn-ghost.show { display:inline-flex; }

  .toast-wrap { position:fixed; bottom:28px; left:50%; transform:translateX(-50%); z-index:999; pointer-events:none; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .launch-info {
    background:var(--cream); border:1px solid var(--border);
    border-radius:13px; padding:13px 16px; font-size:13px; color:var(--ink-mid);
    line-height:1.6; margin-bottom:14px; display:none;
    position:relative;
  }
  .launch-info.show { display:block; }
  .launch-info strong { color:var(--ink); }
  .launch-info-dismiss {
    position:absolute; top:8px; right:8px;
    width:22px; height:22px; border-radius:6px;
    background:none; border:none; cursor:pointer;
    font-size:13px; color:var(--ink-light);
    display:flex; align-items:center; justify-content:center;
    transition:color .15s, background .15s; line-height:1;
  }
  .launch-info-dismiss:hover { color:var(--ink); background:var(--border); }
  .batch-estimate {
    display:inline-flex; align-items:center; gap:6px;
    background:var(--terra-light); border:1px solid rgba(179,97,45,.2);
    border-radius:99px; padding:3px 10px; font-size:12px; font-weight:600;
    color:var(--terra-dark); margin-top:8px;
  }
  /* Buttons */
  .btn-primary {
    width:100%; padding:16px 24px;
    background:linear-gradient(160deg, #2e1a0a 0%, #1c1008 60%);
    color:white; border:none; border-radius:15px;
    font-family:'Fraunces',serif; font-size:19px; font-weight:600; letter-spacing:-.4px;
    cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;
    transition:transform .12s, box-shadow .2s;
    box-shadow:0 5px 22px rgba(28,16,8,.28), inset 0 1px 0 rgba(255,255,255,.08);
    position:relative; overflow:hidden;
  }
  .btn-primary::after {
    content:''; position:absolute; top:0; left:-100%; width:60%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent);
    transition:left .5s ease; pointer-events:none;
  }
  .btn-primary:hover::after { left:150%; }
  .btn-primary:hover { box-shadow:0 8px 30px rgba(28,16,8,.32); transform:translateY(-1px); }
  .btn-primary:active { transform:scale(.99) translateY(0); }
  .btn-primary:disabled { background:var(--border); color:var(--ink-light); cursor:not-allowed; box-shadow:none; transform:none; }
  .btn-primary:disabled::after { display:none; }

  .btn-secondary {
    padding:10px 18px; background:white; color:var(--ink);
    border:1.5px solid var(--border); border-radius:11px;
    font-family:'DM Sans',sans-serif; font-size:13px; font-weight:500;
    cursor:pointer; transition:background .15s, border-color .15s;
    box-shadow:0 1px 4px var(--shadow);
  }
  .btn-secondary:hover { background:var(--cream); border-color:var(--ink-light); }

  /* Settings overlay */
  .settings-overlay {
    display:none; position:fixed; inset:0; z-index:200;
    background:rgba(28,16,8,.4); backdrop-filter:blur(6px);
    align-items:flex-start; justify-content:center;
    padding:40px 20px; overflow-y:auto;
  }
  .settings-overlay.open { display:flex; }
  .settings-sheet {
    background:var(--cream); border-radius:24px; border:1px solid var(--border);
    box-shadow:0 24px 80px rgba(28,16,8,.28), 0 8px 24px rgba(28,16,8,.12);
    width:100%; max-width:580px;
    animation:sheetIn .3s cubic-bezier(.22,1,.36,1); overflow:hidden;
  }
  @keyframes sheetIn { from{opacity:0;transform:translateY(20px) scale(.98)} to{opacity:1;transform:translateY(0) scale(1)} }
  .settings-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:20px 24px; border-bottom:1px solid var(--border); background:white;
  }
  .settings-title { font-family:'Fraunces',serif; font-size:22px; font-weight:600; letter-spacing:-.5px; }
  .settings-close {
    width:32px; height:32px; border-radius:8px;
    background:var(--cream-dark); border:none; cursor:pointer;
    font-size:14px; display:flex; align-items:center; justify-content:center;
    transition:background .15s;
  }
  .settings-close:hover { background:var(--border); }
  .settings-body { padding:24px; }
  .settings-section-label { font-size:10.5px; font-weight:700; letter-spacing:.14em; text-transform:uppercase; color:var(--ink-light); margin-bottom:14px; }

  /* Combo rows */
  .combo-list { display:flex; flex-direction:column; gap:10px; margin-bottom:14px; }
  .combo-row {
    background:white; border:1.5px solid var(--border); border-radius:13px;
    padding:14px 16px; display:grid; gap:8px;
    grid-template-columns:1fr 1fr;
    position:relative;
    box-shadow:0 1px 4px var(--shadow);
    transition:border-color .2s;
  }
  .combo-row:focus-within { border-color:var(--terra); }
  .combo-row-header { grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; }
  .combo-badge {
    display:flex; align-items:center; gap:7px;
    font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--ink-mid);
  }
  .combo-color { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
  .combo-remove {
    background:none; border:none; cursor:pointer; color:var(--ink-light);
    font-size:12px; padding:3px 7px; border-radius:6px;
    transition:color .15s, background .15s; font-family:'DM Sans',sans-serif;
  }
  .combo-remove:hover { color:var(--red); background:var(--red-light); }
  .combo-field { display:flex; flex-direction:column; gap:5px; }
  .combo-field.full { grid-column:1/-1; }
  .combo-field label { font-size:10px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--ink-light); }
  .combo-field input {
    border:1.5px solid var(--border); border-radius:8px; padding:8px 11px;
    font-family:'DM Sans',sans-serif; font-size:13px; color:var(--ink); background:var(--cream);
    outline:none; transition:border-color .2s, box-shadow .2s;
  }
  .combo-field input:focus { border-color:var(--terra); box-shadow:0 0 0 3px rgba(179,97,45,.1); background:white; }
  .combo-field input::placeholder { color:#c0a88a; }

  .add-combo-btn {
    display:flex; align-items:center; gap:8px; justify-content:center;
    width:100%; padding:12px; background:var(--cream); border:1.5px dashed var(--border);
    border-radius:12px; cursor:pointer; font-family:'DM Sans',sans-serif;
    font-size:13px; font-weight:500; color:var(--ink-light);
    transition:border-color .2s, color .2s, background .2s;
  }
  .add-combo-btn:hover { border-color:var(--terra); color:var(--terra); background:var(--terra-light); }

  .settings-save-btn {
    width:100%; padding:15px; background:var(--ink); color:white; border:none;
    border-radius:13px; font-family:'Fraunces',serif; font-size:18px; font-weight:600;
    cursor:pointer; margin-top:22px; transition:background .2s, transform .1s;
    box-shadow:0 4px 16px var(--shadow-lg);
  }
  .settings-save-btn:hover { background:#2e1a08; }

  /* Progress bar ‚Äî lives inside queue card footer */
  .progress-footer { padding:14px 20px 16px; border-top:1px solid var(--border); }
  .progress-bar-track { height:4px; background:var(--border); border-radius:99px; overflow:hidden; }
  .progress-bar-fill { height:100%; background:var(--sage); border-radius:99px; transition:width .4s ease; }
  .progress-bar-label { font-size:11px; color:var(--ink-light); margin-top:6px; font-weight:500; }
  .toast-wrap { position:fixed; bottom:28px; left:50%; transform:translateX(-50%); z-index:999; pointer-events:none; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .toast {
    background:linear-gradient(135deg, #2e1a0a, #1c1008); color:white;
    padding:11px 20px; border-radius:100px; font-size:14px; font-weight:500;
    display:flex; align-items:center; gap:8px;
    box-shadow:0 8px 28px rgba(28,16,8,.32), inset 0 1px 0 rgba(255,255,255,.08);
    animation:tIn .22s cubic-bezier(.22,1,.36,1), tOut .25s ease 2.4s forwards;
    white-space:nowrap;
  }
  @keyframes tIn  { from{opacity:0;transform:translateY(12px) scale(.96)} to{opacity:1;transform:translateY(0) scale(1)} }
  @keyframes tOut { from{opacity:1} to{opacity:0;transform:translateY(-6px)} }

  /* All done state */
  .all-done-banner {
    background:linear-gradient(145deg, #3e7a58, #2e6247); color:white;
    border-radius:16px; padding:20px 22px; text-align:center;
    margin-bottom:14px; display:none;
    box-shadow:0 4px 18px rgba(78,143,106,.3);
  }
  .all-done-banner.show { display:block; animation:fadeUp .35s cubic-bezier(.22,1,.36,1); }
  .all-done-banner-title { font-family:'Fraunces',serif; font-size:22px; font-weight:700; letter-spacing:-.4px; margin-bottom:4px; }
  .all-done-banner-sub { font-size:13px; opacity:.82; }

  /* Copy fallback */
  .copy-fallback-overlay {
    position:fixed; inset:0; z-index:9999; background:rgba(28,16,8,.55);
    backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center; padding:20px;
  }
  .copy-fallback-sheet {
    background:var(--cream); border-radius:20px; border:1px solid var(--border);
    box-shadow:0 20px 60px rgba(28,16,8,.3); width:100%; max-width:520px; overflow:hidden;
  }
  .copy-fallback-header {
    padding:16px 22px; border-bottom:1px solid var(--border); background:white;
    display:flex; align-items:center; justify-content:space-between;
  }
  .copy-fallback-header span { font-family:'Fraunces',serif; font-size:18px; font-weight:600; }
  .copy-fallback-close { width:30px; height:30px; border-radius:7px; background:var(--cream-dark); border:none; cursor:pointer; font-size:14px; }
  .copy-fallback-body { padding:16px 22px; }
  .copy-fallback-body p { font-size:13px; color:var(--ink-light); margin-bottom:10px; }
  .copy-fallback-ta { width:100%; height:140px; border:1.5px solid var(--border); border-radius:10px; padding:10px 12px; font-size:12px; font-family:monospace; color:var(--ink); background:var(--cream); resize:none; outline:none; }
  .copy-fallback-go { margin-top:10px; width:100%; padding:12px; background:var(--ink); color:white; border:none; border-radius:10px; font-family:'Fraunces',serif; font-size:17px; font-weight:600; cursor:pointer; }

  /* Blurbs section */
  .settings-divider { border:none; border-top:1px solid var(--border); margin:22px 0; }
  .blurb-input-row { display:flex; gap:8px; margin-bottom:12px; }
  .blurb-input-row input {
    flex:1; border:1.5px solid var(--border); border-radius:8px; padding:8px 11px;
    font-family:'DM Sans',sans-serif; font-size:13px; color:var(--ink); background:var(--cream);
    outline:none; transition:border-color .2s, box-shadow .2s;
  }
  .blurb-input-row input:focus { border-color:var(--terra); box-shadow:0 0 0 3px rgba(179,97,45,.1); background:white; }
  .blurb-input-row input::placeholder { color:#c0a88a; }
  .blurb-add-btn {
    padding:8px 14px; background:var(--terra-light); border:1.5px solid var(--terra);
    color:var(--terra-dark); border-radius:8px; font-family:'DM Sans',sans-serif;
    font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap;
    transition:background .15s;
  }
  .blurb-add-btn:hover { background:var(--terra); color:white; }
  .blurb-list { display:flex; flex-wrap:wrap; gap:7px; min-height:10px; }
  .blurb-pill {
    display:inline-flex; align-items:center; gap:6px;
    background:var(--gold-light); border:1.5px solid #e8c87a; color:var(--ink-mid);
    border-radius:100px; padding:5px 10px 5px 13px;
    font-size:12px; font-weight:500;
  }
  .blurb-pill-remove {
    width:16px; height:16px; border-radius:50%; background:rgba(192,128,16,.2);
    border:none; cursor:pointer; font-size:10px; color:var(--gold);
    display:flex; align-items:center; justify-content:center;
    transition:background .15s; line-height:1; padding:0;
  }
  .blurb-pill-remove:hover { background:var(--gold); color:white; }
  .blurb-empty { font-size:12px; color:var(--ink-light); font-style:italic; }

  .pacing-hint { font-size:11px; color:var(--ink-light); margin-top:8px; line-height:1.5; }

  /* Pace preset cards */
  .pace-cards { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:4px; }
  .pace-card {
    border:2px solid var(--border); border-radius:14px; padding:14px 12px 12px;
    cursor:pointer; background:var(--cream); transition:border-color .18s, background .18s, box-shadow .18s;
    text-align:center; user-select:none;
  }
  .pace-card:hover { border-color:var(--sage); background:white; }
  .pace-card.selected {
    border-color:var(--sage); background:var(--sage-light);
    box-shadow:0 0 0 3px rgba(78,143,106,.13);
  }
  .pace-card-emoji { font-size:22px; margin-bottom:6px; line-height:1; }
  .pace-card-label { font-size:13px; font-weight:700; color:var(--ink); margin-bottom:3px; }
  .pace-card-desc { font-size:10.5px; color:var(--ink-light); line-height:1.4; margin-bottom:8px; min-height:28px; }
  .pace-card-stats { font-size:10.5px; font-weight:600; color:var(--sage-dark); background:rgba(78,143,106,.1); border-radius:99px; padding:3px 8px; display:inline-block; line-height:1.5; }

  /* Warmup scheduler */
  .warmup-toggle-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .warmup-toggle-label { font-size:13px; font-weight:500; color:var(--ink); }
  .warmup-toggle-sub { font-size:11px; color:var(--ink-light); margin-top:1px; }
  .toggle-switch { position:relative; width:40px; height:22px; flex-shrink:0; }
  .toggle-switch input { opacity:0; width:0; height:0; position:absolute; }
  .toggle-track {
    position:absolute; inset:0; border-radius:99px;
    background:var(--border); cursor:pointer; transition:background .2s;
  }
  .toggle-track::after {
    content:''; position:absolute; top:3px; left:3px;
    width:16px; height:16px; border-radius:50%; background:white;
    box-shadow:0 1px 3px rgba(0,0,0,.2); transition:transform .2s;
  }
  .toggle-switch input:checked + .toggle-track { background:var(--sage); }
  .toggle-switch input:checked + .toggle-track::after { transform:translateX(18px); }
  .warmup-body { display:none; }
  .warmup-body.show { display:block; }
  .warmup-progress-wrap { background:white; border:1.5px solid var(--border); border-radius:12px; padding:14px 16px; margin-bottom:12px; }
  .warmup-progress-label { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px; }
  .warmup-progress-label span:first-child { font-size:13px; font-weight:600; color:var(--ink); }
  .warmup-progress-label span:last-child { font-size:11px; color:var(--ink-light); }
  .warmup-bar-track { height:6px; background:var(--border); border-radius:99px; overflow:hidden; margin-bottom:6px; }
  .warmup-bar-fill { height:100%; background:linear-gradient(90deg, var(--sage), var(--sage-dark)); border-radius:99px; transition:width .4s ease; }
  .warmup-week-badge { display:inline-flex; align-items:center; gap:5px; background:var(--sage-light); border:1px solid var(--sage); color:var(--sage-dark); border-radius:100px; padding:3px 10px; font-size:11px; font-weight:600; }
  .warmup-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }

  /* Batch size warning */
  .batch-warn {
    display:none; background:var(--gold-light); border:1.5px solid #e8c87a;
    border-radius:13px; padding:13px 16px; margin-bottom:14px;
    font-size:13px; color:var(--ink-mid); line-height:1.55;
  }
  .batch-warn.show { display:block; }
  .batch-warn strong { color:var(--terra-dark); }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="header">
    <div>
      <div class="header-eyebrow">Claude in Chrome Workflow</div>
      <h1 class="header-title">Mom's <em>Post Helper</em></h1>
    </div>
    <div class="header-right">
      <div class="info-popover-wrap">
        <button class="icon-btn" onclick="toggleInfo(event)" title="How this works" style="font-family:'Fraunces',serif;font-style:italic;font-size:20px;font-weight:600;color:var(--ink-mid);">i</button>
        <div class="info-popover" id="infoPopover">
          <div class="info-popover-title">How this works</div>
          <p>Add Amazon URLs to your queue. Claude will open each product page, use <strong>Chickadeasy</strong> to generate the affiliate caption, then post to each of your Facebook groups using the correct account ‚Äî automatically. Set up your account + group combos in Settings first.</p>
        </div>
      </div>
      <button class="icon-btn settings-btn" onclick="openSettings()" title="Settings">
        <span class="gear-icon">&#9881;</span>
        <span class="settings-dot" id="settingsDot"></span>
      </button>
    </div>
  </div>

  <!-- No combos warning -->
  <div class="no-combos-warn" id="noCombosWarn">
    <span>&#9888; Set up your Facebook account + group combos in Settings before posting.</span>
    <button onclick="openSettings()">Open Settings</button>
  </div>

  <!-- URL input -->
  <div class="card">
    <div class="card-body">
      <div class="url-row">
        <input type="text" id="urlInput" placeholder="Paste an Amazon product URL to add to queue..." onkeydown="if(event.key==='Enter')addToQueue()" oninput="updateAddBtn();document.getElementById('urlError').textContent='';">
        <button class="add-btn" id="addBtn" onclick="addToQueue()">Add</button>
      </div>
      <div id="urlError" style="font-size:12px;color:var(--red);font-weight:500;min-height:18px;margin-top:5px;"></div>
    </div>
  </div>

  <!-- Queue -->
  <div class="card">
    <div class="card-top">
      <span class="card-label"><span class="card-dot"></span>Queue</span>
      <span id="queueCount" style="font-size:12px;color:var(--ink-light);font-weight:500"></span>
    </div>
    <div class="card-body" id="queueBody" style="padding:0 20px">
    </div>
    <div class="progress-footer" id="progressFooter" style="display:none">
      <div class="progress-bar-track"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
      <div class="progress-bar-label" id="progressLabel"></div>
    </div>
  </div>

  <!-- All done banner -->
  <div class="all-done-banner" id="allDoneBanner">
    <div style="font-size:36px;margin-bottom:8px">&#127881;</div>
    <div class="all-done-banner-title">All done!</div>
    <div class="all-done-banner-sub">All enabled combos posted successfully.</div>
  </div>

  <!-- Launch -->
  <div class="launch-section">
    <div class="batch-warn" id="batchWarn"></div>
    <div class="launch-info" id="launchInfo">
      <button class="launch-info-dismiss" onclick="dismissLaunchInfo()" title="Dismiss">&#10005;</button>
      <strong>Session mode.</strong> Each session covers a small batch of posts. Copy the prompt, paste it into the Claude sidebar ‚Äî Claude posts the batch and tells you when to come back for the next one. Laptop needs to stay awake during each session, but can sleep between them.
    </div>
    <div id="batchEstimate" style="display:none;margin-bottom:14px;"></div>
    <button class="btn-primary" id="launchBtn" onclick="launch()" disabled>
      &#10022; Generate &amp; Copy Prompt
    </button>
    <div class="action-row">
      <button class="btn-ghost" id="clearDoneBtn" onclick="clearDone()">Clear posted</button>
      <button class="btn-ghost" id="clearAllBtn" onclick="clearAll()">Clear all</button>
    </div>
  </div>

</div><!-- /wrap -->

<!-- Settings overlay -->
<div class="settings-overlay" id="settingsOverlay" onclick="overlayClick(event)">
  <div class="settings-sheet">
    <div class="settings-header">
      <span class="settings-title">Settings</span>
      <button class="settings-close" onclick="forceCloseSettings()">&#10005;</button>
    </div>
    <div class="settings-body">
      <div class="settings-section-label">Facebook Account + Group Combos</div>
      <p style="font-size:13px;color:var(--ink-light);line-height:1.6;margin-bottom:16px;">
        Each combo is one Facebook account + one group. Claude will post to every combo for every product in your queue.
        Use the <strong>exact account name</strong> shown in Facebook's account switcher.
      </p>
      <div class="combo-list" id="comboList"></div>
      <button class="add-combo-btn" onclick="addCombo()" id="addComboBtn">&#43; Add account + group combo</button>

      <hr class="settings-divider">

      <div class="settings-section-label">Mom's Blurbs</div>
      <p style="font-size:13px;color:var(--ink-light);line-height:1.6;margin-bottom:14px;">
        Add words, phrases, or vibes that sound like <em>you</em>. Claude will use these as inspiration when writing the 4‚Äì6 word opening blurb for each Facebook post ‚Äî keeping your voice consistent without being repetitive.
      </p>
      <div class="blurb-input-row">
        <input type="text" id="blurbInput" placeholder="e.g. obsessed with this find, great for gifting, game changer‚Ä¶"
          onkeydown="if(event.key==='Enter'){event.preventDefault();addBlurb();}">
        <button class="blurb-add-btn" onclick="addBlurb()">Add</button>
      </div>
      <div class="blurb-list" id="blurbList"></div>

      <hr class="settings-divider">

      <div class="settings-section-label">Posting Pace</div>
      <p style="font-size:13px;color:var(--ink-light);line-height:1.6;margin-bottom:14px;">
        Controls how fast Claude posts. When in doubt, use Normal.
      </p>
      <div class="pace-cards">
        <div class="pace-card" id="paceCard_careful" onclick="selectPace('careful')">
          <div class="pace-card-emoji">üê¢</div>
          <div class="pace-card-label">Careful</div>
          <div class="pace-card-desc">New accounts or after any warnings</div>
          <span class="pace-card-stats">4 posts ¬∑ 30 min break</span>
        </div>
        <div class="pace-card" id="paceCard_normal" onclick="selectPace('normal')">
          <div class="pace-card-emoji">üëç</div>
          <div class="pace-card-label">Normal</div>
          <div class="pace-card-desc">Recommended for most accounts</div>
          <span class="pace-card-stats">6 posts ¬∑ 20 min break</span>
        </div>
        <div class="pace-card" id="paceCard_active" onclick="selectPace('active')">
          <div class="pace-card-emoji">‚ö°</div>
          <div class="pace-card-label">Active</div>
          <div class="pace-card-desc">Established accounts only</div>
          <span class="pace-card-stats">8 posts ¬∑ 15 min break</span>
        </div>
      </div>
      <p class="pacing-hint" id="paceHint"></p>

      <button class="settings-save-btn" onclick="closeSettings()">Done</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
const COMBO_COLORS = ['#7eb8a0','#e8856a','#c9913a','#8a85d4','#d47eb8','#6aa3d4','#8ac470','#d4a46a'];
let queue = [];
let combos = [];
let blurbs = [];
const PACE_PRESETS = {
  careful: { minDelay:60, maxDelay:120, switchDelay:90, sessionSize:4,  sessionBreak:30, spreadHours:12, dailyMax:15 },
  normal:  { minDelay:45, maxDelay:90,  switchDelay:60, sessionSize:6,  sessionBreak:20, spreadHours:10, dailyMax:25 },
  active:  { minDelay:30, maxDelay:60,  switchDelay:45, sessionSize:8,  sessionBreak:15, spreadHours:8,  dailyMax:40 },
};
let pacing = { ...PACE_PRESETS.normal, preset:'normal' };
let warmup = { enabled:false, currentLimit:20, targetLimit:40, weeklyIncrement:5, weekStart:null };

function extractAsin(url){
  const m = url.match(/\/(?:dp|gp\/product|ASIN)\/([A-Z0-9]{10})/i);
  return m ? m[1].toUpperCase() : null;
}

function isFacebookUrl(url){
  if(!url) return false;
  try{
    const host = new URL(url).hostname.replace(/^www\./,'');
    return /(facebook\.com|fb\.com)$/.test(host);
  }catch(e){ return false; }
}

function getInvalidCombos(){
  return combos.filter(c =>
    !c.accountName.trim() ||
    !c.groupUrl.trim() ||
    !(c.template||'').trim() ||
    !isFacebookUrl(c.groupUrl)
  );
}
function ls(k,v){ try{ if(v===undefined) return localStorage.getItem(k); localStorage.setItem(k,typeof v==='string'?v:JSON.stringify(v)); }catch(e){ return null; } }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function saveQueue(){ ls('mph2_queue', JSON.stringify(queue)); }
function loadQueue(){ try{ const v=ls('mph2_queue'); queue=v?JSON.parse(v):[]; }catch(e){ queue=[]; } }
function saveCombos(){ ls('mph2_combos', JSON.stringify(combos)); }
function loadCombos(){ try{ const v=ls('mph2_combos'); combos=v?JSON.parse(v):[]; }catch(e){ combos=[]; } }
function saveBlurbs(){ ls('mph2_blurbs', JSON.stringify(blurbs)); }
function loadBlurbs(){ try{ const v=ls('mph2_blurbs'); blurbs=v?JSON.parse(v):[]; }catch(e){ blurbs=[]; } }
function savePacing(){ ls('mph2_pacing', JSON.stringify(pacing)); }
function loadPacing(){
  try{
    const v = ls('mph2_pacing');
    if(v){
      const saved = JSON.parse(v);
      const preset = saved.preset || 'normal';
      // Apply preset values as base, then overlay saved (in case preset values changed)
      pacing = { ...PACE_PRESETS[preset] || PACE_PRESETS.normal, preset };
    }
  }catch(e){}
}
function saveWarmup(){ ls('mph2_warmup', JSON.stringify(warmup)); }
function loadWarmup(){
  try{
    const v=ls('mph2_warmup');
    if(v) warmup = Object.assign({enabled:false,currentLimit:20,targetLimit:40,weeklyIncrement:5,weekStart:null}, JSON.parse(v));
  }catch(e){}
}

function effectiveDailyMax(){
  return warmup.enabled ? warmup.currentLimit : pacing.dailyMax;
}

// ‚îÄ‚îÄ Status helpers ‚îÄ‚îÄ
function isPendingStatus(status){
  return !status || status === 'pending' || status === 'failed';
}

// ‚îÄ‚îÄ Batch management ‚îÄ‚îÄ
function hasBatchAssignments(){
  return queue.length > 0 && queue.every(p => p.batch != null);
}

function splitIntoBatches(){
  // Pure computation ‚Äî always runs, no toast, no side effects beyond saving
  if(queue.length === 0 || combos.length === 0){
    queue.forEach(p => p.batch = 1); // no combos yet ‚Äî assign all to batch 1
    saveQueue(); return;
  }
  let batchNum = 1;
  let comboCount = 0;
  queue.forEach(p => {
    const dis = p.disabledCombos || {};
    const active = combos.filter(c => !dis[c.id]).length;
    if(comboCount > 0 && active > 0 && comboCount + active > pacing.sessionSize){
      batchNum++;
      comboCount = 0;
    }
    p.batch = batchNum;
    comboCount += active;
  });
  saveQueue();
}

function getTotalBatches(){
  if(!hasBatchAssignments()) return 0;
  return Math.max(...queue.map(p => p.batch));
}

function getCurrentBatch(){
  if(!hasBatchAssignments()) return null;
  const sorted = [...new Set(queue.map(p => p.batch))].sort((a,b) => a-b);
  for(const bn of sorted){
    const hasPending = queue
      .filter(p => p.batch === bn)
      .some(p => {
        const dis = p.disabledCombos || {};
        return combos.some(c => !dis[c.id] && isPendingStatus(p.statuses[c.id]));
      });
    if(hasPending) return bn;
  }
  return null;
}

function getCurrentBatchItems(){
  const bn = getCurrentBatch();
  if(bn == null) return [];
  return queue.filter(p => p.batch === bn);
}

function getBatchEstimate(){
  // Returns { totalBatches, totalPosts, sessionGapMin, totalMinutes } for all pending work
  if(queue.length === 0 || combos.length === 0) return null;
  const totalBatches = getTotalBatches() || 1;
  const totalPosts = queue.reduce((s,p)=>{
    const dis = p.disabledCombos || {};
    return s + combos.filter(c=>!dis[c.id] && isPendingStatus(p.statuses[c.id])).length;
  }, 0);
  if(totalPosts === 0) return null;
  const avgPostSec = (pacing.minDelay + pacing.maxDelay) / 2;
  const postingMin = Math.round(totalPosts * avgPostSec / 60);
  const sessionGapMin = totalBatches > 1
    ? Math.max(pacing.sessionBreak, Math.floor((pacing.spreadHours * 60) / totalBatches))
    : 0;
  const totalMinutes = postingMin + (totalBatches - 1) * sessionGapMin;
  return { totalBatches, totalPosts, sessionGapMin, totalMinutes };
}

function fmtDuration(minutes){
  if(minutes < 60) return `${minutes} min`;
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return m > 0 ? `${h} hr ${m} min` : `${h} hr`;
}

function renderBatchEstimate(){
  const el = document.getElementById('batchEstimate');
  if(!el) return;
  const est = getBatchEstimate();
  if(!est){ el.style.display='none'; return; }
  el.style.display = 'block';
  const currentBatch = getCurrentBatch();
  const remaining = currentBatch != null ? (est.totalBatches - currentBatch + 1) : 0;
  const gapNote = est.sessionGapMin > 0 ? ` ¬∑ ~${est.sessionGapMin} min between batches` : '';
  if(remaining > 0 && remaining < est.totalBatches){
    el.innerHTML = `<span class="batch-estimate">üì¶ ${remaining} batch${remaining!==1?'es':''} left ¬∑ ~${fmtDuration(est.totalMinutes * remaining / est.totalBatches)}${gapNote}</span>`;
  } else {
    el.innerHTML = `<span class="batch-estimate">üì¶ ${est.totalBatches} batch${est.totalBatches!==1?'es':''} ¬∑ ~${fmtDuration(est.totalMinutes)} total${gapNote}</span>`;
  }
}

function advanceWarmupIfNeeded(){
  if(!warmup.enabled || warmup.currentLimit >= warmup.targetLimit) return;
  const now = Date.now();
  const weekMs = 7 * 24 * 60 * 60 * 1000;
  if(!warmup.weekStart){
    warmup.weekStart = now;
    saveWarmup(); return;
  }
  const elapsed = now - warmup.weekStart;
  const weeksElapsed = Math.floor(elapsed / weekMs);
  if(weeksElapsed >= 1){
    warmup.currentLimit = Math.min(warmup.targetLimit, warmup.currentLimit + weeksElapsed * warmup.weeklyIncrement);
    warmup.weekStart = now - (elapsed % weekMs); // carry over fractional week
    saveWarmup();
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
function init(){
  loadQueue();
  loadCombos();
  loadBlurbs();
  loadPacing();
  loadWarmup();
  advanceWarmupIfNeeded();
  renderSettingsCombos();
  renderBlurbs();
  renderPaceCards();
  splitIntoBatches();
  renderQueue();
  checkWarning();
  updateAddBtn();
  updateLaunchBtn();
  updateBatchWarn();
}

// ‚îÄ‚îÄ Combos ‚îÄ‚îÄ
function addCombo(){
  if(combos.length >= 8){ toast('Max 8 combos'); return; }
  combos.push({ id:'c'+Date.now(), accountName:'', groupName:'', groupUrl:'', template:'', commentTemplate:'', color:COMBO_COLORS[combos.length%COMBO_COLORS.length] });
  saveCombos();
  renderSettingsCombos();
}

// ‚îÄ‚îÄ Blurbs ‚îÄ‚îÄ
function addBlurb(){
  const inp = document.getElementById('blurbInput');
  const text = inp.value.trim().slice(0, 120); // cap at 120 chars
  if(!text) return;
  if(blurbs.some(b=>b.toLowerCase()===text.toLowerCase())){ toast('Already in your blurbs'); inp.select(); return; }
  if(blurbs.length >= 30){ toast('Max 30 blurbs'); return; }
  blurbs.push(text);
  saveBlurbs();
  renderBlurbs();
  inp.value = '';
  inp.focus();
}

function removeBlurb(idx){
  blurbs.splice(idx, 1);
  saveBlurbs();
  renderBlurbs();
}

function renderBlurbs(){
  const list = document.getElementById('blurbList');
  if(!list) return;
  if(blurbs.length === 0){
    list.innerHTML = '<span class="blurb-empty">No blurbs yet ‚Äî add some phrases above</span>';
    return;
  }
  list.innerHTML = blurbs.map((b, i)=>`
    <span class="blurb-pill">
      ${esc(b)}
      <button class="blurb-pill-remove" onclick="removeBlurb(${i})" title="Remove">‚úï</button>
    </span>`).join('');
}

// ‚îÄ‚îÄ Pacing ‚îÄ‚îÄ
const PACE_LABELS = {
  careful: { daily:'Up to 15 posts/day across the day' },
  normal:  { daily:'Up to 25 posts/day across the day' },
  active:  { daily:'Up to 40 posts/day across the day' },
};

function renderPaceCards(){
  ['careful','normal','active'].forEach(name=>{
    const card = document.getElementById('paceCard_'+name);
    if(card) card.className = 'pace-card' + (pacing.preset===name ? ' selected' : '');
  });
  const hint = document.getElementById('paceHint');
  if(hint) hint.textContent = PACE_LABELS[pacing.preset]?.daily || '';
}

function selectPace(name){
  if(!PACE_PRESETS[name]) return;
  pacing = { ...PACE_PRESETS[name], preset:name };
  savePacing();
  splitIntoBatches();
  renderPaceCards();
  renderQueue();
  updateBatchWarn();
  updateLaunchBtn();
}

// ‚îÄ‚îÄ Warmup ‚îÄ‚îÄ
function renderWarmup(){
  const enabledEl = document.getElementById('warmupEnabled');
  if(enabledEl) enabledEl.checked = warmup.enabled;
  const body = document.getElementById('warmupBody');
  if(body) body.className = 'warmup-body' + (warmup.enabled ? ' show' : '');

  const set = (id, val) => { const el=document.getElementById(id); if(el) el.value=val; };
  set('warmupStart', warmup.currentLimit);
  set('warmupTarget', warmup.targetLimit);
  set('warmupIncrement', warmup.weeklyIncrement);

  // Progress bar
  const pct = warmup.targetLimit > warmup.currentLimit
    ? Math.round((warmup.currentLimit - (warmup.currentLimit - warmup.weeklyIncrement)) / (warmup.targetLimit - (warmup.targetLimit - warmup.weeklyIncrement * Math.ceil((warmup.targetLimit - warmup.currentLimit) / warmup.weeklyIncrement + 1))) * 100)
    : 100;
  // Simpler: progress from startLimit to targetLimit
  const startGuess = warmup.currentLimit; // approximate ‚Äî we don't store original start
  const progressPct = warmup.targetLimit > 0
    ? Math.round(Math.min(100, (warmup.currentLimit / warmup.targetLimit) * 100))
    : 100;

  const fillEl = document.getElementById('warmupBarFill');
  if(fillEl) fillEl.style.width = progressPct + '%';

  const labelEl = document.getElementById('warmupProgressLabel');
  if(labelEl){
    if(warmup.currentLimit >= warmup.targetLimit){
      labelEl.textContent = `Target reached ¬∑ ${warmup.currentLimit} posts/day`;
    } else {
      const weeksLeft = Math.ceil((warmup.targetLimit - warmup.currentLimit) / warmup.weeklyIncrement);
      labelEl.textContent = `Current limit ¬∑ ${warmup.currentLimit} posts/day`;
      const eta = document.getElementById('warmupETA');
      if(eta) eta.textContent = `‚öë ${weeksLeft} week${weeksLeft!==1?'s':''} to reach ${warmup.targetLimit}/day at +${warmup.weeklyIncrement}/week. Next increase: ${nextWarmupDate()}.`;
    }
  }

  const minEl = document.getElementById('warmupBarMin');
  const maxEl = document.getElementById('warmupBarMax');
  if(minEl) minEl.textContent = '0';
  if(maxEl) maxEl.textContent = warmup.targetLimit + '/day';

  const badgeEl = document.getElementById('warmupWeekBadge');
  if(badgeEl){
    if(warmup.currentLimit >= warmup.targetLimit){
      badgeEl.innerHTML = `<span class="warmup-week-badge">‚úì Target reached</span>`;
    } else if(warmup.weekStart){
      const daysIn = Math.floor((Date.now() - warmup.weekStart) / (24*60*60*1000));
      const daysLeft = 7 - (daysIn % 7);
      badgeEl.innerHTML = `<span class="warmup-week-badge">${daysLeft}d until next increase</span>`;
    } else {
      badgeEl.innerHTML = `<span class="warmup-week-badge">Week 1</span>`;
    }
  }
}

function nextWarmupDate(){
  if(!warmup.weekStart) return 'next week';
  const next = new Date(warmup.weekStart + 7*24*60*60*1000);
  return next.toLocaleDateString('en-US', {month:'short', day:'numeric'});
}

function toggleWarmup(){
  warmup.enabled = document.getElementById('warmupEnabled').checked;
  if(warmup.enabled && !warmup.weekStart) warmup.weekStart = Date.now();
  saveWarmup();
  renderWarmup();
  updateBatchWarn();
}

function updateWarmup(){
  const get = (id, def, min, max) => {
    const v = parseInt(document.getElementById(id)?.value, 10);
    return isNaN(v) ? def : Math.min(max, Math.max(min, v));
  };
  warmup.currentLimit    = get('warmupStart', 20, 5, 60);
  warmup.targetLimit     = get('warmupTarget', 40, 10, 60);
  warmup.weeklyIncrement = get('warmupIncrement', 5, 1, 15);
  if(warmup.currentLimit > warmup.targetLimit) warmup.targetLimit = warmup.currentLimit;
  saveWarmup();
  renderWarmup();
  updateBatchWarn();
}

function updateBatchWarn(){
  const el = document.getElementById('batchWarn');
  if(!el) return;
  if(queue.length === 0 || combos.length === 0){ el.className='batch-warn'; return; }

  const limit = effectiveDailyMax();
  const perAccount = {};
  combos.forEach(c=>{
    const acct = c.accountName.trim() || c.id;
    if(!perAccount[acct]) perAccount[acct] = 0;
    queue.forEach(p=>{
      const dis = p.disabledCombos || {};
      if(!dis[c.id] && (!p.statuses[c.id]||p.statuses[c.id]==='pending'||p.statuses[c.id]==='failed')){
        perAccount[acct]++;
      }
    });
  });

  const overLimit = Object.entries(perAccount).filter(([,n])=>n>limit);
  if(overLimit.length === 0){ el.className='batch-warn'; return; }

  const limitLabel = warmup.enabled ? `warmup limit of ${limit}` : `daily limit of ${limit}`;
  const lines = overLimit.map(([acct,n])=>`<strong>${esc(acct)}</strong>: ${n} posts`).join(' ¬∑ ');
  el.innerHTML = `‚ö†Ô∏è <strong>Batch exceeds ${limitLabel}.</strong> ${lines}. Consider splitting across multiple days.`;
  el.className = 'batch-warn show';
}

function removeCombo(id){
  combos = combos.filter(c=>c.id!==id);
  saveCombos();
  renderSettingsCombos();
  renderQueue(); // status chips change
  checkWarning();
}

function updateCombo(id, field, value){
  const c = combos.find(c=>c.id===id);
  if(!c) return;
  c[field]=value; saveCombos();
}

function sanitizeGroupUrl(id){
  const c = combos.find(c=>c.id===id);
  if(!c) return;
  let value = c.groupUrl.trim();
  if(!value) return;

  const clearField = (msg) => {
    toast(msg);
    c.groupUrl = '';
    saveCombos();
    const row = document.getElementById('crow_'+id);
    if(row){ const inp = row.querySelectorAll('input')[2]; if(inp) inp.value=''; }
  };

  // Block dangerous protocols
  if(/^(javascript|data|vbscript):/i.test(value)){
    clearField('‚ö†Ô∏è Invalid URL ‚Äî must be a Facebook group URL'); return;
  }
  // Auto-prepend https:// only if no protocol present
  if(!/^https?:\/\//i.test(value)){
    value = 'https://' + value;
  }
  // Validate it's a Facebook URL ‚Äî reject non-facebook, don't just warn
  try{
    const host = new URL(value).hostname.replace(/^www\./,'');
    if(!/(facebook\.com|fb\.com)$/.test(host)){
      clearField('‚ö†Ô∏è Must be a facebook.com URL (e.g. https://facebook.com/groups/...)'); return;
    }
  }catch(e){
    clearField('‚ö†Ô∏è Invalid URL format'); return;
  }
  c.groupUrl = value;
  saveCombos();
  const row = document.getElementById('crow_'+id);
  if(row){ const inp = row.querySelectorAll('input')[2]; if(inp) inp.value=value; }
}

function renderSettingsCombos(){
  const list = document.getElementById('comboList');
  if(combos.length===0){
    list.innerHTML='<div style="text-align:center;padding:20px;color:var(--ink-light);font-size:13px;">No combos yet ‚Äî add one below</div>';
    document.getElementById('addComboBtn').style.display='flex';
    return;
  }
  list.innerHTML = combos.map((c,i)=>`
    <div class="combo-row" id="crow_${c.id}">
      <div class="combo-row-header">
        <span class="combo-badge"><span class="combo-color" style="background:${c.color}"></span>Combo ${i+1}</span>
        <button class="combo-remove" onclick="removeCombo('${c.id}')">&#10005; Remove</button>
      </div>
      <div class="combo-field">
        <label>Facebook Account Name</label>
        <input type="text" placeholder="e.g. Jane Smith" value="${esc(c.accountName)}"
          oninput="updateCombo('${c.id}','accountName',this.value)">
      </div>
      <div class="combo-field">
        <label>Group Name (for reference)</label>
        <input type="text" placeholder="e.g. Jane's Deals" value="${esc(c.groupName)}"
          oninput="updateCombo('${c.id}','groupName',this.value)">
      </div>
      <div class="combo-field full">
        <label>Facebook Group URL</label>
        <input type="text" placeholder="https://facebook.com/groups/..." value="${esc(c.groupUrl)}"
          oninput="updateCombo('${c.id}','groupUrl',this.value)"
          onblur="sanitizeGroupUrl('${c.id}')">
      </div>
      <div class="combo-field full">
        <label>Chickadeasy Post Template</label>
        <input type="text" placeholder="Exact name from Chickadeasy dropdown, e.g. Default Template" value="${esc(c.template||'')}"
          oninput="updateCombo('${c.id}','template',this.value)">
      </div>
      <div class="combo-field full">
        <label>Chickadeasy Comment Template <span style="font-weight:400;opacity:.7;">(optional ‚Äî for first comment)</span></label>
        <input type="text" placeholder="e.g. Comment Template ‚Äî leave blank to post URL only" value="${esc(c.commentTemplate||'')}"
          oninput="updateCombo('${c.id}','commentTemplate',this.value)">
      </div>
    </div>
  `).join('');
  document.getElementById('addComboBtn').style.display = combos.length<8 ? 'flex' : 'none';
}

// ‚îÄ‚îÄ Queue ‚îÄ‚îÄ
function updateAddBtn(){
  const v = document.getElementById('urlInput').value.trim();
  const valid = /^(https?:\/\/|www\.)/i.test(v) && v.length>10;
  const btn = document.getElementById('addBtn');
  btn.style.opacity = valid ? '' : '0.5';
  btn.style.cursor = valid ? '' : 'default';
}

function setUrlError(msg){
  const el = document.getElementById('urlError');
  if(!el) return;
  el.textContent = msg;
  if(msg){
    clearTimeout(el._t);
    el._t = setTimeout(()=>{ el.textContent=''; }, 3500);
  }
}

function shakeInput(){
  const inp = document.getElementById('urlInput');
  inp.style.borderColor = 'var(--red)';
  inp.style.boxShadow = '0 0 0 3.5px rgba(196,48,48,.15)';
  inp.addEventListener('input', function clear(){
    inp.style.borderColor=''; inp.style.boxShadow='';
    inp.removeEventListener('input', clear);
  }, {once:true});
  setTimeout(()=>{ inp.style.borderColor=''; inp.style.boxShadow=''; }, 3000);
}

function addToQueue(){
  const inp = document.getElementById('urlInput');
  const url = inp.value.trim();
  if(!url){ shakeInput(); setUrlError('Paste an Amazon product URL first'); return; }
  if(!/^(https?:\/\/|www\.)/i.test(url)){ shakeInput(); setUrlError('URL must start with https://'); return; }
  if(!isAmazonUrl(url)){ shakeInput(); setUrlError('Only Amazon product URLs are supported'); return; }
  if(!extractAsin(url)){ shakeInput(); setUrlError('No product ASIN found ‚Äî paste a direct product URL'); return; }
  setUrlError('');
  addUrlsToQueue([url]);
  inp.value='';
  updateAddBtn();
}

function removeFromQueue(id){
  queue = queue.filter(p=>p.id!==id);
  splitIntoBatches();
  renderQueue();
  updateLaunchBtn();
  updateBatchWarn();
}

function isAmazonUrl(url){
  // Reject URLs with HTML characters in them (malformed/XSS attempts)
  if(/[<>"']/.test(url)) return false;
  try {
    const parsed = new URL(url.startsWith('http') ? url : 'https://'+url);
    const host = parsed.hostname.replace(/^www\./,'');
    return /^(amazon\.(com|co\.uk|ca|de|fr|it|es|co\.jp|com\.au|com\.br|nl|pl|se|in|com\.mx)|amzn\.(to|com))$/.test(host);
  } catch(e){ return false; }
}

function addUrlsToQueue(urls){
  let added=0, dupes=0, nonAmazon=0, noAsin=0;
  urls.forEach(url=>{
    url = url.trim();
    if(!url || !/^(https?:\/\/|www\.)/i.test(url) || url.length<10) return;
    if(!isAmazonUrl(url)){ nonAmazon++; return; }
    // Require a valid ASIN
    const asin = extractAsin(url);
    if(!asin){ noAsin++; return; }
    // ASIN-level dedup
    if(queue.some(p=>extractAsin(p.url)===asin)){ dupes++; return; }
    const statuses={};
    combos.forEach(c=>{ statuses[c.id]='pending'; });
    queue.push({ id:'p'+Date.now()+Math.random().toString(36).slice(2,6), url, addedAt:Date.now(), statuses, disabledCombos:{} });
    added++;
  });
  if(added>0){ splitIntoBatches(); renderQueue(); updateLaunchBtn(); updateBatchWarn(); }
  if(added>1) toast(`Added ${added} product${added!==1?'s':''}`+(dupes?` (${dupes} duplicate${dupes!==1?'s':''} skipped)`:''));
  else if(added===1) toast('Added to queue'+(dupes?' (1 duplicate skipped)':''));
  else if(dupes>0) toast('Already in queue ‚Äî duplicate skipped');
  else if(noAsin>0) toast('‚ö†Ô∏è No product ASIN found ‚Äî paste a direct product URL');
  else if(nonAmazon>0) toast('‚ö†Ô∏è Only Amazon product URLs are supported');
}

// Paste handler ‚Äî intercepts multi-URL pastes
document.getElementById('urlInput').addEventListener('paste', function(e){
  const text = (e.clipboardData||window.clipboardData).getData('text');
  const lines = text.split(/[\n\r]+/).map(s=>s.trim()).filter(Boolean);
  if(lines.length > 1){
    e.preventDefault();
    addUrlsToQueue(lines);
    this.value='';
    updateAddBtn();
  }
  // single URL ‚Äî let it paste normally and user hits Add/Enter
});

function renderQueueItem(p, i){
  const asin = extractAsin(p.url);
  const displayLabel = p.name
    ? p.name
    : asin ? `ASIN: ${asin}`
    : p.url.replace(/^https?:\/\/(www\.)?/,'').slice(0,55)+(p.url.length>65?'‚Ä¶':'');
  const disabled = p.disabledCombos || {};
  const chips = combos.map(c=>{
    const isDisabled = !!disabled[c.id];
    const isPosted = p.statuses[c.id]==='posted';
    const st = isDisabled ? 'skipped' : (p.statuses[c.id] || 'pending');
    const label = c.groupName || c.accountName || 'Combo '+(combos.indexOf(c)+1);
    const title = isDisabled ? `Click to re-enable for this product` : isPosted ? `Posted` : `Click to skip for this product`;
    const clickable = !isPosted;
    return `<span class="status-chip ${st}" title="${title}"${clickable?` onclick="toggleCombo('${p.id}','${c.id}')"`:''}><span class="chip-dot"></span>${esc(label.length>18?label.slice(0,16)+'‚Ä¶':label)}</span>`;
  }).join('');
  const enabledCombos = combos.filter(c=>!disabled[c.id]);
  const allPosted = enabledCombos.length>0 && enabledCombos.every(c=>p.statuses[c.id]==='posted');
  const hasFailed = enabledCombos.some(c=>p.statuses[c.id]==='failed');
  return `<div class="queue-item no-anim${allPosted?' all-posted':''}" id="qi_${p.id}"
    draggable="true"
    ondragstart="dragStart(event,${i})"
    ondragover="dragOver(event,${i})"
    ondragleave="dragLeave(event)"
    ondragend="dragEnd(event)"
    ondrop="dragDrop(event,${i})">
    <span class="qi-drag" title="Drag to reorder">‚†ø</span>
    <div class="qi-num">${allPosted ? '‚úì' : i+1}</div>
    <div class="qi-content">
      <div class="qi-url"><a href="${esc(p.url)}" target="_blank" rel="noopener">${esc(displayLabel)}</a></div>
      <div class="qi-statuses">${chips.length?chips:'<span style="font-size:12px;color:var(--ink-light)">Set up combos in Settings</span>'}</div>
    </div>
    ${hasFailed ? `<button class="qi-retry" onclick="launchSingle('${p.id}',this)" title="Copy prompt to retry failed groups">‚Ü∫</button>` : ''}
    <button class="qi-remove" onclick="removeFromQueue('${p.id}')" title="Remove">&#10005;</button>
  </div>`;
}

function dismissLaunchInfo(){
  ls('mph2_launchInfoDismissed', '1');
  document.getElementById('launchInfo').className = 'launch-info';
}

function renderQueue(){
  const body = document.getElementById('queueBody');
  const countEl = document.getElementById('queueCount');
  const progressFooter = document.getElementById('progressFooter');
  const launchInfo = document.getElementById('launchInfo');
  const dismissed = ls('mph2_launchInfoDismissed') === '1';

  if(queue.length===0){
    body.innerHTML = `<div class="queue-empty"><div class="queue-empty-icon">üçÉ</div>Add some Amazon URLs above to get started</div>`;
    countEl.textContent='';
    progressFooter.style.display='none';
    launchInfo.className='launch-info';
    document.getElementById('clearDoneBtn').className='btn-ghost';
    document.getElementById('clearAllBtn').className='btn-ghost';
    renderBatchEstimate();
    checkAllDone();
    return;
  }
  countEl.textContent = queue.length+' product'+(queue.length!==1?'s':'');
  launchInfo.className = 'launch-info' + (dismissed ? '' : ' show');
  renderBatchEstimate();

  const currentBatch = getCurrentBatch();
  const batches = {};
  queue.forEach((p,i)=>{
    const bn = p.batch || 1;
    if(!batches[bn]) batches[bn] = [];
    batches[bn].push({p,i});
  });
  body.innerHTML = Object.entries(batches)
    .sort(([a],[b])=>Number(a)-Number(b))
    .map(([bn, entries])=>{
      const batchNum = Number(bn);
      const isCurrent = batchNum === currentBatch;
      const allDone = entries.every(({p})=>{
        const dis = p.disabledCombos || {};
        const active = combos.filter(c=>!dis[c.id]);
        return active.length===0 || active.every(c=>p.statuses[c.id]==='posted'||p.statuses[c.id]==='failed');
      });
      const divLabel = `Batch ${bn}${allDone ? ' ‚úì' : isCurrent ? ' ‚Äî up next' : ''}`;
      const divClass = `batch-divider${isCurrent?' current':''}${allDone?' done':''}`;
      const divider = `<div class="${divClass}"><span class="batch-divider-label">${divLabel}</span></div>`;
      return divider + entries.map(({p,i})=>renderQueueItem(p,i)).join('');
    }).join('');

  progressFooter.style.display = 'block';
  updateProgressBar();

  const hasDone = queue.some(p=>Object.values(p.statuses).some(s=>s==='posted'));
  document.getElementById('clearDoneBtn').className = 'btn-ghost'+(hasDone?' show':'');
  document.getElementById('clearAllBtn').className = 'btn-ghost'+(queue.length?' show':'');
  checkAllDone();
}

function updateProgressBar(){
  let total=0, done=0;
  queue.forEach(p=>{
    const disabled = p.disabledCombos || {};
    combos.forEach(c=>{
      if(disabled[c.id]) return;
      total++;
      if(p.statuses[c.id]==='posted') done++;
    });
  });
  const pct = total>0 ? Math.round(done/total*100) : 0;
  document.getElementById('progressFill').style.width = pct+'%';
  document.getElementById('progressLabel').textContent = done+' of '+total+' post'+(total!==1?'s':'')+' completed';
}

function checkAllDone(){
  if(queue.length===0){ document.getElementById('allDoneBanner').className='all-done-banner'; return; }
  const allDone = combos.length>0 && queue.every(p=>{
    const disabled = p.disabledCombos || {};
    const active = combos.filter(c=>!disabled[c.id]);
    return active.length===0 || active.every(c=>p.statuses[c.id]==='posted'||p.statuses[c.id]==='failed');
  });
  document.getElementById('allDoneBanner').className = 'all-done-banner'+(allDone?' show':'');
}

function clearDone(){
  queue = queue.filter(p=>{
    const dis = p.disabledCombos || {};
    const active = combos.filter(c=>!dis[c.id]);
    return !(active.length===0 || active.every(c=>p.statuses[c.id]==='posted'));
  });
  splitIntoBatches();
  renderQueue();
  updateLaunchBtn();
}

function clearAll(){
  showConfirm(
    `Clear all ${queue.length} item${queue.length!==1?'s':''} from the queue?`,
    ()=>{ queue=[]; saveQueue(); renderQueue(); updateLaunchBtn(); }
  );
}

function showConfirm(message, onConfirm){
  const el = document.createElement('div');
  el.className = 'copy-fallback-overlay';
  el.style.zIndex='10000';
  el.innerHTML=`<div class="copy-fallback-sheet" style="max-width:360px;">
    <div class="copy-fallback-header"><span>Confirm</span></div>
    <div class="copy-fallback-body">
      <p style="margin-bottom:16px;">${esc(message)}</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button class="btn-secondary" id="_confirmCancel">Cancel</button>
        <button class="settings-save-btn" style="width:auto;padding:10px 20px;margin-top:0;font-size:14px;" id="_confirmOk">Clear</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(el);
  const dismiss = ()=>el.remove();
  const confirm = ()=>{ el.remove(); onConfirm(); };
  el.querySelector('#_confirmOk').onclick = confirm;
  el.querySelector('#_confirmCancel').onclick = dismiss;
  el.onclick = e=>{ if(e.target===el) dismiss(); };
  // Use document-level keydown so ESC fires regardless of focus state
  const onKey = e=>{ if(e.key==='Escape'){ e.stopPropagation(); dismiss(); document.removeEventListener('keydown',onKey,true); } };
  document.addEventListener('keydown', onKey, true);
  // Auto-focus cancel so keyboard works naturally
  el.querySelector('#_confirmCancel').focus();
}

function getPendingItems(){
  return queue.filter(p=>{
    const dis = p.disabledCombos || {};
    return combos.some(c=>!dis[c.id]&&(!p.statuses[c.id]||p.statuses[c.id]==='pending'||p.statuses[c.id]==='failed'));
  });
}

function getNextSessionItems(){
  // Pack products until we'd exceed sessionSize combos.
  // A single product with more combos than sessionSize is always included alone.
  const pending = getPendingItems();
  const items = [];
  let comboCount = 0;
  for(const p of pending){
    const dis = p.disabledCombos || {};
    const active = combos.filter(c=>!dis[c.id]&&(!p.statuses[c.id]||p.statuses[c.id]==='pending'||p.statuses[c.id]==='failed')).length;
    if(comboCount + active > pacing.sessionSize && items.length > 0) break;
    items.push(p);
    comboCount += active;
  }
  return items;
}

function updateLaunchBtn(){
  const btn = document.getElementById('launchBtn');
  const pendingItems = getPendingItems();

  if(pendingItems.length === 0 || combos.length === 0){
    btn.disabled = true;
    btn.innerHTML = '&#10022; Generate &amp; Copy Prompt';
    return;
  }

  btn.disabled = false;

  const currentBatch = getCurrentBatch();
  if(currentBatch == null){
    btn.disabled = true;
    btn.innerHTML = '&#10022; All batches complete';
    return;
  }

  const totalBatches = getTotalBatches();
  const batchItems = getCurrentBatchItems();
  const batchPending = batchItems.reduce((s,p)=>{
    const dis = p.disabledCombos || {};
    return s + combos.filter(c=>!dis[c.id] && isPendingStatus(p.statuses[c.id])).length;
  },0);
  const batchesAfter = totalBatches - currentBatch;
  const afterLabel = batchesAfter > 0
    ? `${batchesAfter} batch${batchesAfter!==1?'es':''} after`
    : 'last batch';

  btn.innerHTML = `&#10022; Generate batch ${currentBatch} &nbsp;<span style="font-weight:400;font-size:13px;opacity:.85">${batchPending} post${batchPending!==1?'s':''} &middot; ${afterLabel}</span>`;
}

function toggleCombo(productId, comboId){
  if(dragSrcIdx !== null) return; // suppress clicks during drag
  const p = queue.find(x=>x.id===productId);
  if(!p) return;
  if(!p.disabledCombos) p.disabledCombos={};
  if(p.disabledCombos[comboId]) delete p.disabledCombos[comboId];
  else p.disabledCombos[comboId]=true;
  saveQueue();
  renderQueue();
  updateLaunchBtn();
}

// ‚îÄ‚îÄ Drag to reorder ‚îÄ‚îÄ
let dragSrcIdx = null;
function dragStart(e, idx){
  dragSrcIdx = idx;
  e.dataTransfer.effectAllowed = 'move';
  e.currentTarget.classList.add('dragging');
}
function dragOver(e, idx){
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  document.querySelectorAll('.queue-item').forEach(el=>el.classList.remove('drag-over'));
  if(idx !== dragSrcIdx) e.currentTarget.classList.add('drag-over');
}
function dragLeave(e){ e.currentTarget.classList.remove('drag-over'); }
function dragEnd(e){ e.currentTarget.classList.remove('dragging','drag-over'); dragSrcIdx = null; }
function dragDrop(e, idx){
  e.preventDefault();
  document.querySelectorAll('.queue-item').forEach(el=>el.classList.remove('drag-over','dragging'));
  if(dragSrcIdx===null || dragSrcIdx===idx) return;
  const moved = queue.splice(dragSrcIdx, 1)[0];
  queue.splice(idx, 0, moved);
  dragSrcIdx = null;
  saveQueue();
  renderQueue();
}

function checkWarning(){
  const hasValid = combos.some(c=>c.accountName.trim() && c.groupUrl.trim() && (c.template||'').trim());
  const missing = !hasValid;
  document.getElementById('noCombosWarn').className='no-combos-warn'+(missing?' show':'');
  document.getElementById('settingsDot').className='settings-dot'+(missing?' show':'');
}

// ‚îÄ‚îÄ Build Prompt ‚îÄ‚îÄ
function buildPrompt(items){
  if(!items || items.length===0) return null;
  const comboList = combos.map((c,i)=>`  ${i+1}. Account: "${c.accountName.trim()}" ‚Üí Group: "${(c.groupName||'(see URL)').trim()}" (URL: ${c.groupUrl.trim()})`).join('\n');
  const productList = items.map((p,i)=>`  Product ${i+1} [ID: ${p.id}]: ${p.url}`).join('\n');
  const isPending = (p, c) => isPendingStatus(p.statuses[c.id]);
  const totalPosts = items.reduce((sum,p)=>{ const dis=p.disabledCombos||{}; return sum+combos.filter(c=>!dis[c.id]&&isPending(p,c)).length; },0);

  // Blurb guidance section
  const blurbSection = blurbs.length > 0
    ? `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
MOM'S VOICE ‚Äî BLURB GUIDANCE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
For every Facebook post, write a fresh 4‚Äì6 word opening blurb in the first line of the post (before the Chickadeasy caption). The blurb should feel personal, slightly different each time, and reflect this person's voice and style. Draw inspiration from these words and phrases she provided:

${blurbs.map(b=>`  ‚Ä¢ ${b.replace(/[\r\n\t]/g,' ')}`).join('\n')}

Rules for the blurb:
- 4‚Äì6 words maximum, punchy and natural-sounding
- Never repeat the exact same blurb twice in one batch
- Place it on its own line at the very top of the post body, followed by a blank line, then the Chickadeasy caption
- Do NOT add hashtags or emojis unless they naturally match her voice from the list above`
    : `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
OPENING BLURB
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
For every Facebook post, write a fresh 4‚Äì6 word opening blurb on the first line of the post (before the Chickadeasy caption). Keep it warm, natural, and slightly different each time. No hashtags or emojis unless they feel right.`;

  const perProductSteps = items.map((p,i)=>{
    const disabled = p.disabledCombos || {};
    const activeCombos = combos.filter(c=>!disabled[c.id]&&isPending(p,c));
    if(activeCombos.length===0) return `\n---\nPRODUCT ${i+1} [ID: ${p.id}]\nURL: ${p.url}\n  (all combos skipped for this product)\n---`;

    const templateGroups = {};
    activeCombos.forEach(c=>{
      const tmpl = c.template || 'Default Template';
      if(!templateGroups[tmpl]) templateGroups[tmpl]=[];
      templateGroups[tmpl].push(c);
    });

    const templateBlocks = Object.entries(templateGroups).map(([tmpl, tCombos], ti)=>{
      const comboSteps = tCombos.map((c,ci)=>{
        const hasCommentTmpl = (c.commentTemplate||'').trim();
        const commentStep = hasCommentTmpl
          ? `        FIRST COMMENT:
          a. After the post publishes, find the comment box on the new post
          b. Navigate back to the Amazon tab and use Chickadeasy to generate the comment caption:
             - In the SiteStripe template dropdown, select "${c.commentTemplate.trim()}" ‚Äî match exactly
             - Click the chickadee bird icon ‚Äî comment caption is now in clipboard
          c. Paste the comment caption, then add the affiliate URL on a new line:
             ${p.url}
          d. Submit the comment`
          : `        FIRST COMMENT:
          a. After the post publishes, find the comment box on the new post
          b. Type or paste this URL as the first comment:
             ${p.url}
          c. Submit the comment`;

        return `
      COMBO ‚Äî Account: "${c.accountName.trim()}" ‚Üí "${(c.groupName||c.groupUrl).trim()}" [comboId: ${c.id}]
        a. Execute on dashboard tab: window.setWorking('${p.id}','${c.id}')
        b. On facebook.com, confirm active account is "${c.accountName.trim()}" ‚Äî switch if needed
        c. Navigate to: ${c.groupUrl.trim()}
        d. Wait for group page to fully load
        e. Click "Write something..." or "Create post" to open the composer
        f. Click the "Photo/Video" or camera icon in the composer to add media
        g. Drag the product image (from your product image tab) into the photo attachment area, OR use the file picker if drag-and-drop isn't available. If this is not the first combo using this image, try selecting a different image from the product's image carousel (alternate angle or lifestyle shot) to avoid identical image fingerprints across posts.
        h. Click inside the text area. On the FIRST LINE, write the 4‚Äì6 word opening blurb ‚Äî make it slightly different from the blurb used for any previous combo in this batch (same product, different phrasing). Press Enter twice. Then paste (Ctrl+V) the Chickadeasy caption for template "${tmpl}". Do NOT include the Amazon URL in the post body.
        i. Click the blue Post button and wait for confirmation
        j. On success: window.updateStatus('${p.id}','${c.id}','posted')
           On failure: window.updateStatus('${p.id}','${c.id}','failed') ‚Äî describe error, continue
${commentStep}
        ‚è± MANDATORY DELAY: After this combo is fully complete (post + comment submitted), wait a randomized ${pacing.minDelay}‚Äì${pacing.maxDelay} seconds before starting the next combo. Vary the exact wait ‚Äî don't use the same number twice in a row.`;
      }).join('\n');

      return `
  TEMPLATE GROUP ${ti+1}: "${tmpl}" ‚Üí used by ${tCombos.length} combo(s)

    STEP A ‚Äî Grab product image:
      a. Navigate to: ${p.url}
      b. Wait up to 20 seconds for the page to fully load (including the Chickadeasy SiteStripe bar)
      c. While waiting, grab the product title: read the text of #productTitle element (or fall back to page <title> before the first colon). Then execute on the dashboard tab:
         window.setProductName('${p.id}', 'THE TITLE YOU JUST READ')
         Then switch back to the Amazon tab.
      d. Find the main product image: look for the element with id "landingImage" ‚Äî get its src attribute (use the full-resolution URL, not a thumbnail). If not found, check #imgTagWrappingLink img or the first large image in #imageBlock.
      e. Open that image URL in a new tab so it's ready to drag into the Facebook post composer.

    STEP B ‚Äî Write the opening blurb:
      Before posting, compose a 4‚Äì6 word opening blurb for this product. It will go at the top of every post in this template group. Write it now and remember it ‚Äî it should feel natural and personal.

    STEP C ‚Äî Generate post caption with Chickadeasy (template: "${tmpl}"):
      a. On the Amazon tab, wait for the Chickadeasy SiteStripe bar to appear at the top of the page
      b. In the SiteStripe template dropdown, select "${tmpl}" ‚Äî match the name exactly
      c. Click the chickadee bird icon ‚Äî the post caption is now in clipboard
      d. Navigate to https://www.facebook.com (keep caption in clipboard ‚Äî do not copy anything else)

    STEP D ‚Äî Post to all combos using this caption + image:
${comboSteps}`;
    }).join('\n\n  ---\n');

    return `
---
PRODUCT ${i+1} [ID: ${p.id}]
URL: ${p.url}
${templateBlocks}

  After all combos for this product: execute window.markProductDone('${p.id}')
---`;
  }).join('\n');

  // Build status snapshot across ALL queue items (not just items in this batch)
  const isResume = queue.some(p=>combos.some(c=>p.statuses[c.id]==='posted'));
  const statusSnapshot = queue.map((p,i)=>{
    const dis = p.disabledCombos || {};
    const label = p.name || extractAsin(p.url) || `Product ${i+1}`;
    const comboSummary = combos.map(c=>{
      if(dis[c.id]) return `    ${c.groupName||c.accountName}: skipped`;
      const st = p.statuses[c.id] || 'pending';
      return `    ${c.groupName||c.accountName}: ${st}`;
    }).join('\n');
    return `  ${label} [${p.id}]:\n${comboSummary}`;
  }).join('\n');

  // Compute suggested gap before next session, based on spread window and remaining work
  const allPendingCombos = queue.reduce((s,p)=>{
    const dis = p.disabledCombos || {};
    return s + combos.filter(c=>!dis[c.id]&&(!p.statuses[c.id]||p.statuses[c.id]==='pending'||p.statuses[c.id]==='failed')).length;
  }, 0);
  const totalSessions = Math.max(1, Math.ceil(allPendingCombos / pacing.sessionSize));
  const sessionGap = totalSessions > 1
    ? Math.max(pacing.sessionBreak, Math.floor((pacing.spreadHours * 60) / totalSessions))
    : 0;
  const hasMoreSessions = allPendingCombos > totalPosts;

  // Batch size warning for prompt preamble
  const effectiveMax = effectiveDailyMax();
  const perAccountCounts = {};
  combos.forEach(c=>{
    const acct = c.accountName.trim() || c.id;
    if(!perAccountCounts[acct]) perAccountCounts[acct] = 0;
    items.forEach(p=>{
      const dis = p.disabledCombos || {};
      if(!dis[c.id]) perAccountCounts[acct]++;
    });
  });
  const overLimitAccts = Object.entries(perAccountCounts).filter(([,n])=>n>effectiveMax);
  const batchWarningLine = overLimitAccts.length > 0
    ? `\n‚ö†Ô∏è LARGE BATCH WARNING: ${overLimitAccts.map(([a,n])=>`"${a}" has ${n} posts (${warmup.enabled?'warmup':'daily'} limit: ${effectiveMax})`).join(', ')}. Proceed with extra caution ‚Äî enforce all pacing delays strictly.\n`
    : '';

  return `AUTOMATED FACEBOOK POSTING ‚Äî ${items.length} PRODUCT(S) √ó ${combos.length} COMBO(S)
${batchWarningLine}
Generated by Mom's Post Helper. Follow every step precisely. Do not skip steps.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${isResume ? 'RESUMING BATCH ‚Äî STATUS SNAPSHOT' : 'STATUS SNAPSHOT'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${isResume ? 'This is a resumed batch. Some posts are already done ‚Äî do NOT re-post them. The steps below only include work that still needs to happen. Use this snapshot to orient yourself:\n' : ''}${statusSnapshot}
${isResume ? '\nOnly process steps listed below. Anything marked "posted" above is complete ‚Äî skip it.' : ''}

${blurbSection}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
IMPORTANT: THE DASHBOARD TAB
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Keep the Mom's Post Helper tab open the entire time. After each post, you will execute JavaScript on that tab to update the dashboard. The tab URL contains "claude.ai" or is a local HTML file ‚Äî identify it now before you begin.

To update the dashboard, execute JavaScript like this on the Mom's Post Helper tab:
  window.updateStatus('PRODUCT_ID', 'COMBO_ID', 'posted')   ‚Üê after successful post
  window.updateStatus('PRODUCT_ID', 'COMBO_ID', 'failed')   ‚Üê if a post fails
  window.setWorking('PRODUCT_ID', 'COMBO_ID')                ‚Üê while actively working on a combo

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
QUEUE (${queue.length} products)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${productList}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
COMBOS (${combos.length} account + group pairs)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${comboList}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
BEGIN ‚Äî PROCESS EACH PRODUCT IN ORDER
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${perProductSteps}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
HOW TO SWITCH FACEBOOK ACCOUNTS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
- Click the profile picture / avatar at the top-right of facebook.com
- In the dropdown, find the account name and click it
- Wait for the full page reload to complete
- Verify the new account name appears top-right
- ‚è± After switching accounts, wait ${pacing.switchDelay} seconds before navigating to the group. This cooldown is mandatory.
- If the account is missing from the dropdown: mark that combo as failed, inform the user, continue

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚öë ACCOUNT SAFETY RULES ‚Äî READ BEFORE STARTING
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
These rules mirror how a real person posts. The goal is organic-looking activity, not speed.

SESSION CONTEXT ‚Äî this is a single session:
- Complete all ${totalPosts} post${totalPosts!==1?'s':''} in this prompt, then stop. Do not take a mid-session break.
- The user will paste a new prompt for the next session after a break. Your job is to finish this session cleanly and report when done.
- Account switches within this session are fine ‚Äî apply the ${pacing.switchDelay}s cooldown after each switch before navigating

WITHIN-SESSION PACING:
- Wait a randomized ${pacing.minDelay}‚Äì${pacing.maxDelay} seconds between each combo (not metronomic ‚Äî vary it)
- After switching accounts, wait ${pacing.switchDelay} seconds before navigating to the group
- Let pages load fully and naturally ‚Äî don't click before elements are rendered

CONTENT VARIATION (prevents fingerprinting):
- Every opening blurb must differ meaningfully ‚Äî no two combos in the same session should start the same way
- If the Chickadeasy caption is identical to one used in the last 5 posts, rephrase the blurb slightly more to offset it
- Where the product carousel offers alternate shots, use a different image per template group

STOP CONDITIONS ‚Äî pause the entire batch and notify the user:
- Facebook shows any rate-limit notice, "You're posting too fast", or "This action has been blocked"
- Any account hits a security checkpoint, restriction, or phone verification prompt
- You encounter a CAPTCHA or human verification on any account
- Three or more consecutive posts fail without a clear technical reason

HUMAN-LIKE MICRO-BEHAVIORS (do these naturally, not as a checklist):
- Scroll the group feed for 3‚Äì5 seconds before opening the post composer
- After a post publishes, stay on the post for a moment and scroll past it before navigating away
- Occasionally scroll the newsfeed briefly while waiting between posts during the break

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
IF ANYTHING GOES WRONG
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
- CAPTCHA / human verification ‚Üí STOP immediately and notify the user
- Unexpected popup or dialog ‚Üí describe it before clicking anything
- Chickadeasy SiteStripe doesn't appear ‚Üí scroll to top of page, wait 20s, refresh once, try again
- Post composer won't open ‚Üí refresh the group page once, try again
- Product image can't be found or attached ‚Üí skip the image for that combo, note it, continue
- Group not found or access denied ‚Üí mark combo as failed, continue
- Any other error ‚Üí mark the specific combo as failed, continue with the next one

Say "Session complete ‚úì Posted ${totalPosts} post${totalPosts!==1?'s':''} across ${items.length} product${items.length!==1?'s':''} and ${combos.length} account${combos.length!==1?'s':''}. ${hasMoreSessions ? `Come back in about ${sessionGap} minutes to start the next session ‚Äî the dashboard will be ready.` : `That\'s the full queue ‚Äî all done for today!`}" when fully finished.`;
}

// ‚îÄ‚îÄ Launch ‚îÄ‚îÄ
async function launch(){
  const invalid = getInvalidCombos();
  if(invalid.length){
    toast(`‚ö†Ô∏è ${invalid.length} combo(s) missing required fields ‚Äî check Settings`);
    return;
  }
  const items = getCurrentBatchItems();
  if(!items.length){ toast('Nothing left to post!'); return; }
  const prompt = buildPrompt(items);
  if(!prompt){ toast('Nothing left to post!'); return; }

  const ok = await doCopy(prompt);
  if(ok){
    const btn = document.getElementById('launchBtn');
    const orig = btn.textContent;
    btn.textContent = '‚ú¶ Copied!';
    btn.style.background = 'linear-gradient(160deg, var(--sage-dark) 0%, #1e3d2c 60%)';
    toast('Prompt copied ‚Äî paste into Claude sidebar!');
    setTimeout(()=>{
      btn.textContent = orig;
      btn.style.background = '';
      updateLaunchBtn();
    }, 1500);
  } else {
    // Fallback modal is already showing ‚Äî toast so there's some button-area feedback too
    toast('üìã Auto-copy blocked ‚Äî use the popup to copy manually');
  }
}

async function launchSingle(productId, btnEl){
  const invalid = getInvalidCombos();
  if(invalid.length){
    toast(`‚ö†Ô∏è ${invalid.length} combo(s) missing required fields ‚Äî check Settings`);
    return;
  }
  const p = queue.find(x=>x.id===productId);
  if(!p) return;
  const prompt = buildPrompt([p]);
  if(btnEl){
    const orig = btnEl.textContent;
    btnEl.style.pointerEvents='none';
    btnEl.textContent='‚Ä¶';
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
    const ok = await doCopy(prompt);
    if(ok){
      btnEl.textContent='‚úì';
      toast('Single-product prompt copied!');
      setTimeout(()=>{ btnEl.textContent=orig; btnEl.style.pointerEvents=''; }, 2000);
    } else {
      btnEl.textContent=orig; btnEl.style.pointerEvents='';
    }
  } else {
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
    const ok = await doCopy(prompt);
    if(ok) toast('Single-product prompt copied!');
  }
}

async function doCopy(text){
  // Try modern clipboard API
  if(navigator.clipboard){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){}
  }
  // Try legacy execCommand
  try{
    const ta=document.createElement('textarea');
    ta.value=text;
    ta.style.cssText='position:fixed;top:10px;left:10px;width:1px;height:1px;opacity:0.01;';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok=document.execCommand('copy');
    document.body.removeChild(ta);
    if(ok) return true;
  }catch(e){}
  // Both failed ‚Äî show manual fallback
  showCopyFallback(text);
  return false;
}

function showCopyFallback(text){
  const el=document.createElement('div');
  el.className='copy-fallback-overlay';
  el.innerHTML=`<div class="copy-fallback-sheet">
    <div class="copy-fallback-header"><span>Copy this prompt</span><button class="copy-fallback-close" onclick="this.closest('.copy-fallback-overlay').remove()">&#10005;</button></div>
    <div class="copy-fallback-body">
      <p>Browser blocked auto-copy. Select all below and copy manually (Ctrl+A ‚Üí Ctrl+C):</p>
      <textarea class="copy-fallback-ta" id="cfta" readonly>${text}</textarea>
      <button class="copy-fallback-go" onclick="document.getElementById('cfta').select();document.execCommand('copy');this.closest('.copy-fallback-overlay').remove();toast('Copied!')">Select &amp; Copy</button>
    </div>
  </div>`;
  document.body.appendChild(el);
  setTimeout(()=>{ const ta=document.getElementById('cfta'); if(ta){ta.focus();ta.select();} },100);
}

// ‚îÄ‚îÄ Info popover ‚îÄ‚îÄ
function toggleInfo(e){
  e.stopPropagation();
  const p = document.getElementById('infoPopover');
  p.classList.toggle('open');
}
document.addEventListener('click', ()=>{
  document.getElementById('infoPopover').classList.remove('open');
});

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ
function openSettings(){
  advanceWarmupIfNeeded();
  renderBlurbs();
  renderPaceCards();
  document.getElementById('settingsOverlay').className='settings-overlay open';
}

function forceCloseSettings(){
  // Always closes ‚Äî used by ESC, X button, and click-outside
  // Discard ghost combos (added but never filled in) ‚Äî don't persist them
  combos = combos.filter(c=>
    c.accountName.trim() || c.groupName.trim() || c.groupUrl.trim() || (c.template||'').trim()
  );
  document.getElementById('settingsOverlay').className='settings-overlay';
  const validIds = new Set(combos.map(c=>c.id));
  queue.forEach(p=>{
    combos.forEach(c=>{ if(!(c.id in p.statuses)) p.statuses[c.id]='pending'; });
    Object.keys(p.statuses).forEach(id=>{ if(!validIds.has(id)) delete p.statuses[id]; });
    if(p.disabledCombos) Object.keys(p.disabledCombos).forEach(id=>{ if(!validIds.has(id)) delete p.disabledCombos[id]; });
  });
  saveQueue(); saveCombos();
  renderQueue(); checkWarning(); updateLaunchBtn(); updateBatchWarn();
}

function closeSettings(){
  // Validates before closing ‚Äî used by the Done button only
  const incomplete = combos.filter(c=>
    !c.accountName.trim() ||
    !c.groupUrl.trim() ||
    !(c.template||'').trim() ||
    !isFacebookUrl(c.groupUrl)
  );
  if(incomplete.length && combos.length > 0){
    incomplete.forEach(c=>{
      const row = document.getElementById('crow_'+c.id);
      if(!row) return;
      const inputs = row.querySelectorAll('input');
      // inputs: [0:accountName, 1:groupName, 2:groupUrl, 3:template, 4:commentTemplate(optional)]
      [
        {idx:0, val:c.accountName, check: v=>v.trim()},
        {idx:2, val:c.groupUrl,    check: v=>v.trim() && isFacebookUrl(v)},
        {idx:3, val:c.template||'', check: v=>v.trim()},
      ].forEach(({idx, val, check})=>{
        if(!check(val) && inputs[idx]){
          inputs[idx].style.borderColor='var(--red)';
          inputs[idx].style.boxShadow='0 0 0 3px rgba(196,48,48,.15)';
          inputs[idx].addEventListener('input', function fix(){
            this.style.borderColor=''; this.style.boxShadow='';
            this.removeEventListener('input', fix);
          });
        }
      });
    });
    const hasBadUrl = incomplete.some(c=>c.groupUrl.trim() && !isFacebookUrl(c.groupUrl));
    if(hasBadUrl){
      toast('‚ö†Ô∏è Facebook Group URL must be a facebook.com URL');
    } else {
      toast(`‚ö†Ô∏è ${incomplete.length} combo(s) have empty required fields (highlighted in red)`);
    }
    return; // Don't close ‚Äî keep open so user can fix
  }
  forceCloseSettings();
}

function overlayClick(e){ if(e.target===document.getElementById('settingsOverlay')) forceCloseSettings(); }
document.addEventListener('keydown', e=>{
  if(e.key==='Escape' && document.getElementById('settingsOverlay').classList.contains('open')){
    forceCloseSettings();
  }
});

// ‚îÄ‚îÄ Public API for Claude ‚îÄ‚îÄ
window.setProductName = function(productId, name){
  const p = queue.find(x=>x.id===productId);
  if(!p || !name) return;
  p.name = String(name).trim().slice(0, 80);
  saveQueue();
  renderQueue();
};

window.updateStatus = function(productId, comboId, status){
  const p = queue.find(x=>x.id===productId);
  if(!p){ console.warn('updateStatus: product not found', productId); return; }
  if(comboId) p.statuses[comboId] = status;
  saveQueue();
  renderQueue();
  updateLaunchBtn();
};

window.setWorking = function(productId, comboId){
  window.updateStatus(productId, comboId, 'working');
};

window.markProductDone = function(productId){
  renderQueue();
  updateLaunchBtn();
};

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function toast(msg){
  const wrap=document.getElementById('toasts');
  const el=document.createElement('div');
  el.className='toast'; el.textContent=msg;
  wrap.appendChild(el); setTimeout(()=>el.remove(),2800);
}

init();
</script>
</body>
</html>
